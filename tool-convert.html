<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>メディア変換 | Mcommon Study</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .convert-page {
        width: min(1100px, 94%);
        margin: 0 auto;
        padding: calc(var(--header-height) + var(--space-lg)) 0 var(--space-xl);
        display: grid;
        gap: var(--space-lg);
      }
      .convert-hero {
        background: var(--card-glass);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-card);
        padding: var(--space-lg);
        box-shadow: var(--shadow-window);
        backdrop-filter: blur(var(--blur-amount));
      }
      .convert-grid {
        display: grid;
        gap: var(--space-lg);
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .convert-card {
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-card);
        background: var(--card-bg);
        box-shadow: var(--shadow-window);
        padding: var(--space-lg);
        display: grid;
        gap: var(--space-sm);
      }
      .convert-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        flex-wrap: wrap;
      }
      .convert-result {
        min-height: 28px;
        color: var(--text-muted);
      }
      .convert-result a {
        color: var(--accent);
      }
      .download-all {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        margin-top: var(--space-xs);
      }
      .file-row {
        display: grid;
        gap: var(--space-sm);
      }
      .inline {
        display: inline-flex;
        gap: var(--space-xs);
        align-items: center;
      }
      @media (max-width: 900px) {
        .convert-page {
          padding-inline: var(--space-md);
        }
      }
    </style>
  </head>
  <body>
    <div id="site-header"></div>
    <div class="page">
      <main id="main-content" class="convert-page">
        <section class="convert-hero">
          <h1 class="section-title">メディア変換</h1>
          <p class="muted" style="margin:0;">画像は PNG/JPG/WEBP/BMP/AVIF、音声は MP3/AAC/FLAC/OGG/WAV に変換できます（ブラウザ内で実行）。</p>
        </section>

        <section class="convert-grid">
          <article class="convert-card">
            <h3>画像フォーマット変換</h3>
            <p class="muted">複数枚まとめて指定フォーマットへ変換します。</p>
            <div class="file-row">
              <input class="input" id="img-file" type="file" accept="image/*" multiple />
              <div class="inline">
                <label class="form-label" for="img-format" style="margin:0;">出力</label>
                <select class="input" id="img-format" style="min-width:120px;">
                  <option value="png">PNG</option>
                  <option value="jpg">JPG</option>
                  <option value="webp">WEBP</option>
                  <option value="bmp">BMP</option>
                  <option value="avif">AVIF</option>
                </select>
              </div>
            </div>
            <div class="convert-actions">
              <button class="btn btn-primary" id="img-convert">変換</button>
              <button class="btn" id="img-clear">クリア</button>
            </div>
            <div class="convert-result" id="img-result"></div>
            <div class="convert-result" id="img-download-wrap" style="display:none;">
              <button class="btn" id="img-download-all" type="button">一斉ダウンロード</button>
            </div>
          </article>

          <article class="convert-card">
            <h3>音声フォーマット変換</h3>
            <p class="muted">複数音声を MP3 / AAC / FLAC / OGG / WAV に変換。先頭の音声を再生で確認できます。</p>
            <div class="file-row">
              <input class="input" id="aud-file" type="file" accept="audio/*" multiple />
              <div class="inline">
                <label class="form-label" for="aud-format" style="margin:0;">出力</label>
                <select class="input" id="aud-format" style="min-width:120px;">
                  <option value="mp3">MP3</option>
                  <option value="aac">AAC</option>
                  <option value="flac">FLAC</option>
                  <option value="ogg">OGG</option>
                  <option value="wav">WAV</option>
                </select>
              </div>
            </div>
            <div class="convert-result" id="aud-upload-list"></div>
          <div class="convert-actions">
            <button class="btn btn-primary" id="aud-convert">変換</button>
            <button class="btn" id="aud-clear">クリア</button>
          </div>
          <div class="convert-result" id="aud-result"></div>
          <div class="convert-result" id="aud-download-wrap" style="display:none;">
            <button class="btn" id="aud-download-all" type="button">一斉ダウンロード</button>
          </div>
          </article>
        </section>
      </main>
    </div>
    <div id="chatbot-slot"></div>
    <div id="site-footer"></div>

    <script src="/js/layout.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.8/dist/ffmpeg.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const imgFile = document.querySelector('#img-file');
        const imgFmt = document.querySelector('#img-format');
        const imgConvert = document.querySelector('#img-convert');
        const imgClear = document.querySelector('#img-clear');
        const imgResult = document.querySelector('#img-result');
        const imgDownloadAll = document.querySelector('#img-download-all');
        const imgDownloadWrap = document.querySelector('#img-download-wrap');

        const audFile = document.querySelector('#aud-file');
        const audFmt = document.querySelector('#aud-format');
        const audConvert = document.querySelector('#aud-convert');
        const audClear = document.querySelector('#aud-clear');
        const audResult = document.querySelector('#aud-result');
        const audDownloadAll = document.querySelector('#aud-download-all');
        const audDownloadWrap = document.querySelector('#aud-download-wrap');
        const audUploadList = document.querySelector('#aud-upload-list');

        let createFFmpeg, fetchFile, ffmpeg;
        let ffmpegReady = false;

        async function loadFfmpeg() {
          if (!window.FFmpeg) {
            audResult.textContent = 'ffmpeg.wasm を読み込めませんでした（ネットワークが必要です）。簡易WAV変換にフォールバックします。';
            return false;
          }
          if (!createFFmpeg) {
            ({ createFFmpeg, fetchFile } = FFmpeg);
            ffmpeg = createFFmpeg({ log: false });
          }
          if (ffmpegReady) return true;
          audResult.textContent = 'ffmpeg.wasm を読み込み中...';
          await ffmpeg.load();
          ffmpegReady = true;
          audResult.textContent = '';
          return true;
        }

        const baseName = (file) => file.name.replace(/\.[^.]+$/, '');

        imgConvert?.addEventListener('click', convertImage);
        imgClear?.addEventListener('click', () => clearInput(imgFile, imgResult));

        audFile?.addEventListener('change', () => {
          renderUploadList();
        });

        audConvert?.addEventListener('click', convertAudio);
        audClear?.addEventListener('click', () => {
          clearInput(audFile, audResult);
          if (audUploadList) audUploadList.innerHTML = '';
          if (audDownloadWrap) audDownloadWrap.style.display = 'none';
        });
        imgDownloadAll?.addEventListener('click', () => {
          batchDownload(imgResultsBlobs);
        });
        audDownloadAll?.addEventListener('click', () => {
          batchDownload(audResultsBlobs);
        });

        let imgResultsBlobs = [];
        let audResultsBlobs = [];

        function convertImage() {
          imgResult.textContent = '変換中...';
          imgResultsBlobs = [];
          if (imgDownloadWrap) imgDownloadWrap.style.display = 'none';
          if (!imgFile?.files?.length) {
            imgResult.textContent = '画像ファイルを選択してください。';
            return;
          }
          const fmt = imgFmt?.value || 'png';
          const results = [];
          Array.from(imgFile.files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = () => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const mime =
                  fmt === 'jpg'
                    ? 'image/jpeg'
                    : fmt === 'webp'
                    ? 'image/webp'
                    : fmt === 'bmp'
                    ? 'image/bmp'
                    : fmt === 'avif'
                    ? 'image/avif'
                    : 'image/png';
                canvas.toBlob(
                  (blob) => {
                    if (!blob) {
                      results.push(`<div>${file.name}: 変換に失敗しました。</div>`);
                      return;
                    }
                    const url = URL.createObjectURL(blob);
                    imgResultsBlobs.push({ url, name: `${baseName(file)}.${fmt}` });
                    results.push(
                      `<div><a href="${url}" download="${baseName(file)}.${fmt}">${file.name} → ${fmt.toUpperCase()} をダウンロード</a></div>`
                    );
                    imgResult.innerHTML = results.join('');
                    if (imgResultsBlobs.length && imgDownloadWrap) {
                      imgDownloadWrap.style.display = 'block';
                    }
                  },
                  mime
                );
              };
              img.src = reader.result;
            };
            reader.readAsDataURL(file);
          });
        }

        async function convertAudio() {
          if (!audFile?.files?.length) {
            audResult.textContent = '音声ファイルを選択してください。';
            return;
          }
          audResult.textContent = '変換中...';
          audResultsBlobs = [];
          const ok = await loadFfmpeg();
          if (!ok && ok !== undefined) {
            // fallback: WAVのみ
            const results = [];
            let firstPreviewSet = false;
            for (const file of audFile.files) {
              try {
                const arrayBuffer = await file.arrayBuffer();
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const wavBlob = encodeWAV(audioBuffer);
                const url = URL.createObjectURL(wavBlob);
                audResultsBlobs.push({ url, name: `${baseName(file)}.wav` });
                results.push(
                  `<div style="display:grid;gap:6px;">
                    <div><strong>${file.name}</strong> → WAV （簡易）</div>
                    <a href="${url}" download="${baseName(file)}.wav">ダウンロード</a>
                  </div>`
                );
                if (!firstPreviewSet && audPreview) {
                  audPreview.src = url;
                  audPreview.load();
                  firstPreviewSet = true;
                }
              } catch (e) {
                results.push(`<div>${file.name}: 変換に失敗しました。</div>`);
              }
            }
            audResult.innerHTML = results.join('');
            if (audResultsBlobs.length && audDownloadWrap) {
              audDownloadWrap.style.display = 'block';
            }
            return;
          }
          const fmt = audFmt?.value || 'wav';
          const results = [];

          for (const file of audFile.files) {
            try {
              const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
              const nameIn = `in_${crypto.randomUUID()}.${ext}`;
              const nameOut = `out_${crypto.randomUUID()}.${fmt}`;
              ffmpeg.FS('writeFile', nameIn, await fetchFile(file));
              await ffmpeg.run('-i', nameIn, nameOut);
              const data = ffmpeg.FS('readFile', nameOut);
              const mime =
                fmt === 'mp3'
                  ? 'audio/mpeg'
                  : fmt === 'aac'
                  ? 'audio/aac'
                  : fmt === 'flac'
                  ? 'audio/flac'
                  : fmt === 'ogg'
                  ? 'audio/ogg'
                  : 'audio/wav';
              const blob = new Blob([data.buffer], { type: mime });
              const url = URL.createObjectURL(blob);
              audResultsBlobs.push({ url, name: `${baseName(file)}.${fmt}` });
              results.push(
                `<div style="display:grid;gap:6px;">
                  <div><strong>${file.name}</strong> → ${fmt.toUpperCase()}</div>
                  <a href="${url}" download="${baseName(file)}.${fmt}">ダウンロード</a>
                </div>`
              );
              ffmpeg.FS('unlink', nameIn);
              ffmpeg.FS('unlink', nameOut);
            } catch (e) {
              results.push(`<div>${file.name}: 変換に失敗しました。</div>`);
              console.error(e);
            }
          }
          audResult.innerHTML = results.join('');
          if (audResultsBlobs.length && audDownloadWrap) {
            audDownloadWrap.style.display = 'block';
          }
        }

        function clearInput(fileInput, resultEl) {
          if (fileInput) fileInput.value = '';
          if (resultEl) resultEl.textContent = '';
        }

        function renderUploadList() {
          if (!audUploadList) return;
          if (!audFile?.files?.length) {
            audUploadList.textContent = '';
            return;
          }
          const items = Array.from(audFile.files).map((file) => {
            const url = URL.createObjectURL(file);
            return `
              <div style="display:grid;gap:4px;margin-bottom:8px;">
                <strong>${file.name}</strong>
                <audio controls src="${url}" style="width:100%;"></audio>
              </div>
            `;
          });
          audUploadList.innerHTML = items.join('');
        }

        function batchDownload(entries) {
          if (!entries.length) return;
          entries.forEach((item) => {
            const a = document.createElement('a');
            a.href = item.url;
            a.download = item.name;
            a.click();
          });
        }

        function batchDownload(entries) {
          if (!entries.length) return;
          entries.forEach((item) => {
            const a = document.createElement('a');
            a.href = item.url;
            a.download = item.name;
            a.click();
          });
        }
      });
    </script>
  </body>
</html>
